---
title: "ILO - Project Markdown"
author: "Milo Skovfoged"
date: "27/4/2021"
output:
  word_document: default
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(readxl)
#library(readbulk)
library(lubridate)
library(fs)
library(R.utils)
#library(zoo)
library(Rilostat)
library(plotly)
```

# Analysis of Fatalities

## Import, clean, and merged data 

First we download the Fatility data. We download the normalized data per 100.000 worker (INJ_FATL_ECO_RT_A)

```{r DownloadFatility, include=FALSE}
Fatilities <- get_ilostat(id = 'INJ_FATL_ECO_RT_A', 
                          segment = 'indicator', 
                          time_format = "num",
                          filters = list(classif1 = "ECO_AGGREGATE_TOTAL"), 
                          cache = FALSE) %>% 
  filter(str_sub(ref_area,1,1) != 'X') %>%
  select(ref_area, obs_value, time, classif1) %>%
  left_join(Rilostat:::ilostat_ref_area_mapping %>%
              select(ref_area) %>%
              label_ilostat(code = 'ref_area'),
            by = "ref_area") %>%
  rename(TotalFatilitiesNormP100K = obs_value)

Fatilities %>% ggplot(aes(x=TotalFatilitiesNormP100K)) + 
  geom_density()
```

Then we download the labor inspection data. Here we download the different datasets:

1. Number of labor inspectors per 10.000 worker (LAI_INDE_NOC_RT_A)
2. Number of inspections per inspector (LAI_VDIN_NOC_RT_A)
3. Total number of inspections (LAI_VIST_NOC_NB_A)

```{r DownloadLaborInspector, echo=FALSE}
LaborInspectors <- get_ilostat(id = 'LAI_INDE_NOC_RT_A', 
                              segment = 'indicator', 
                              time_format = "num",
                              #filters = list(sex = "SEX_T"), 
                              cache = FALSE) %>% 
  filter(str_sub(ref_area,1,1) != 'X') %>%
  select(ref_area, obs_value, time) %>%
  left_join(Rilostat:::ilostat_ref_area_mapping %>%
              select(ref_area) %>%
              label_ilostat(code = 'ref_area'),
            by = "ref_area") %>%
  rename(LaborInspectorsNormP10K = obs_value)

summary(LaborInspectors)

LaborInspectors %>% ggplot(aes(x=LaborInspectorsNormP10K)) + 
  geom_density()

InspectionsPerInspector <- get_ilostat(id = 'LAI_VDIN_NOC_RT_A', 
                                segment = 'indicator', 
                                time_format = "num",
                                #filters = list(sex = "SEX_T"), 
                                cache = FALSE) %>% 
  filter(str_sub(ref_area,1,1) != 'X') %>%
  select(ref_area, obs_value, time) %>%
  left_join(Rilostat:::ilostat_ref_area_mapping %>%
              select(ref_area) %>%
              label_ilostat(code = 'ref_area'),
            by = "ref_area") %>%
  rename(InspectionsPerInspector = obs_value)

summary(InspectionsPerInspector)

InspectionsPerInspector %>% ggplot(aes(x=InspectionsPerInspector)) + 
  geom_density()

NubLaborInspections <- get_ilostat(id = 'LAI_VIST_NOC_NB_A', 
                               segment = 'indicator', 
                               time_format = "num",
                               #filters = list(sex = "SEX_T"), 
                               cache = FALSE) %>% 
  filter(str_sub(ref_area,1,1) != 'X') %>%
  select(ref_area, obs_value, time) %>%
  left_join(Rilostat:::ilostat_ref_area_mapping %>%
              select(ref_area) %>%
              label_ilostat(code = 'ref_area'),
            by = "ref_area") %>%
  rename(TotalLaborInspections = obs_value)

summary(NubLaborInspections)

NubLaborInspections %>% ggplot(aes(x=TotalLaborInspections)) + 
  geom_density()

```

Them we combine and clean the data.

```{r CleanAndMergeFatalities, echo=FALSE}
CombinedData <- Fatilities %>%
  dplyr::full_join(LaborInspectors, by = NULL, copy = FALSE, keep = FALSE) %>%
  dplyr::full_join(NubLaborInspections, by = NULL, copy = FALSE, keep = FALSE) %>%
  dplyr::full_join(InspectionsPerInspector, by = NULL, copy = FALSE, keep = FALSE)

col_order <- c("ref_area", "ref_area.label", "classif1", "time", "TotalFatilitiesNormP100K", "LaborInspectorsNormP10K", "InspectionsPerInspector", "TotalLaborInspections")

CombinedData <- CombinedData[, col_order]

CombinedDataNoNA <- CombinedData %>% drop_na()
```

An initial linear regission analysis explains Fatilities very little (R-squared:  0.0362)

It indicates a very small statical significants. The number of inspections per inspector increases the number of Fatilities

However, the 
 
```{r SummeryOfData, echo = FALSE}
summary(lm(TotalFatilitiesNormP100K ~ LaborInspectorsNormP10K * InspectionsPerInspector, data = CombinedDataNoNA))
```

```{r PlotFatalies, echo=FALSE}
# Labor Inspectors
CombinedDataNoNA %>% ggplot(aes(x = TotalFatilitiesNormP100K, 
               y = LaborInspectorsNormP10K,
               #color = factor(time)
               ),
               alpha(0.5),
) + 
  geom_point() +
  geom_smooth(method=lm,
              se = T) +
  theme_bw()

CombinedDataNoNA %>% ggplot(aes(x = TotalFatilitiesNormP100K, 
               y = LaborInspectorsNormP10K,
               color = time),
               alpha(0.5),
) + 
  geom_point() +
  geom_smooth(method=lm,
              se = T) +
  facet_wrap(~ref_area.label) +
  theme_bw()

CombinedDataNoNA %>% ggplot(aes(x = TotalFatilitiesNormP100K, 
               y = InspectionsPerInspector,
               color = time
               ),
               alpha(0.5),
) + 
  geom_point() +
  geom_smooth(method=lm,
              se = T) +
  theme_bw()

CombinedDataNoNA %>% ggplot(aes(x = TotalFatilitiesNormP100K, 
               y = InspectionsPerInspector,
               color = time),
               alpha(0.5),
) + 
  geom_point() +
  geom_smooth(method=lm,
              se = T) +
  facet_wrap(~ref_area.label) +
  theme_bw()
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
#plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
